---
title: "Check Coverage"
author: "Kari Norman"
date: "5/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(FD)
devtools::load_all()
```

```{r}
load(here::here("data", "biotime_data.rda"))
load(here::here("data", "elton_mamm.rda"))
load(here::here("data", "elton_bird.rda"))
load(here::here("data", "amphibio.rda"))
```

#Checking Coverage of ID's and trait data -> biotime

check if all bird & mammal biotime data w/id's has an elton match. There are 68 species without a match (63 are birds).
```{r}
no_trait <- biotime_data %>%
  filter(taxa %in% c("Birds", "Mammals")) %>%
  select(id, sourceName, taxa) %>%
  drop_na(id) %>%
  distinct() %>%
  filter(!id %in% elton_bird$id, !id %in% elton_mamm$id)

dim(no_trait)
```

and 19869 species without an ID, some of which are species codes
```{r}
biotime_data %>%
  #filter(taxa == "Birds") %>%
  select(id, sourceName, taxa) %>%
  filter(is.na(id)) %>%
  distinct() %>%
  dim()
```

Are there any studies for which we have trait data for all species?
```{r}
merge_data <- function(trait_data){
  biotime_data %>%
    select(-sourceName, -scientificName) %>%
  left_join(trait_data, by = "id",
            na_matches = "never") %>%
    drop_na(scientificName)
}
```

Get data w/traits for all studies that have >85% trait coverage
```{r}
#set coverage threshold for analysis dataset
percent <- 0.85

traits <- list(elton_bird, elton_mamm, amphibio)

comp_biotime_traits <- map_dfr(traits, merge_data) %>%
  right_join(biotime_data %>% select(-sourceName, -scientificName))

#always check that one species didn't match to multiple datasets, below should return and empty dataframe
#comp_biotime_traits %>% group_by(record_id) %>% filter(n() > 1) %>% dim()

#this gives a coverage for each trait dataset, so potentially a lot of coverage with one dataset and no coverage on all the rest
#need to get rid of zeros when there is coverage from another dataset so we only have one entry per study
coverage <- comp_biotime_traits %>%
  group_by(study_id) %>%
  summarise(perc = sum(!is.na(sourceName))/n()) %>%
  arrange(desc(perc))

inc_coverage <- coverage %>% filter(perc > percent)

biotime_traits <- comp_biotime_traits %>%
  filter(study_id %in% inc_coverage$study_id, !is.na(sourceName))
```

```{r}
usethis::use_data(biotime_traits)
```


Create table of info for each study
```{r}
study_table <- biotime_data %>%
  group_by(study_id) %>%
  mutate(min_year = min(year), max_year = max(year)) %>% 
  #select(study_id, plot, taxa, latitude, longitude, min_year, max_year) %>%
  select(study_id, taxa, min_year, max_year) %>%
  distinct() %>%
  left_join(coverage %>% select(study_id, coverage = perc), by = "study_id")

usethis::use_data(study_table)
```

Get FD metrics for each study 
```{r}
library(furrr)
load(here::here("data", "biotime_traits.rda"))

get_fd <- function(data, study, plot_num){
  print(max(data$record_id))
  
  data <- data %>%
    filter(study_id == study, plot == plot_num)
  
  species_mat <- data %>%
    select(year, id) %>% 
    distinct() %>%
    arrange(year, id) %>%
    mutate(present = 1) %>%
    spread(id, value = present, fill = 0) %>%
    select(-year)
  
  years <- data %>% 
    select(year) %>%
    distinct() %>%
    arrange(year)
  
  trait_mat <- data %>%
    select(-c(taxa, record_id, day, month, year, sample_desc, id_species, 
              latitude, longitude, sum_abundance, sum_biomass, sourceName, scientificName)
    ) %>%
    distinct() %>%
    select_if(~ length(unique(.)) > 1) %>% #remove columns that have the same value for all columns
    mutate_at(vars(-id, -ends_with("5cat")), list(~scales::rescale(.,to=c(0, 1)))) %>% #rescale variables
    arrange(id) %>%
    column_to_rownames("id")
  
  fs::dir_create(paste0(here::here("data"), "/fd_output"))
  
  #the convexhull c code creates an output file of vertices, in order to not have multiple threads writing
  #to the same file we have to create individual working directories
  tmp_dir <- paste0(here::here("data", "fd_output", "tmp"), "/tmp_", study, plot_num)
  fs::dir_create(tmp_dir)
  setwd(tmp_dir)

  fd_out <- as_tibble(dbFD_joggle(trait_mat, species_mat, w.abun = FALSE))[,1:8] %>%
    cbind(years, .) %>%
    mutate(study_id = unlist(study), plot = unlist(plot_num), trait_count = dim(trait_mat)[2]) %>%
    write_tsv(paste0(here::here("data"), "/fd_output/", "s", study, "_p", plot_num, "_fd.tsv"))
  
  setwd(here::here())
  return(fd_out)
}

get_fd_safe <- possibly(get_fd, NA)

data <- biotime_traits %>% 
  filter(!is.na(plot), !is.na(scientificName)) %>% #remove unlabeled plots and observations without traits
  group_by(study_id, year, plot) %>%
  filter(n_distinct(id) > 4) %>%
  ungroup() %>%
  filter(study_id == 516)

combs <- cross2(unique(data$study_id), unique(data$plot))

plan(multiprocess)
fd <- future_map_dfr(combs, ~ get_fd_safe(data = data, study = .x[1], plot = .x[2]))  
```

Read data back in:
```{r}
# files <-  dir(here::here("data", "fd_output"), "*.tsv")
# 
# fd_data <- files %>%
#   paste0(here::here("data", "fd_output"), "/", .) %>%
#   map_dfr(read_tsv)
# 
# fd <- biotime_traits %>%
#   filter(!is.na(plot), !study_id %in% c(195, 360)) %>%
#   anti_join(fd_data) %>%
#   group_by(study_id, year, plot) %>%
#   filter(n_distinct(id) > 4) %>%
#   ungroup() %>%
#   group_by(study_id, plot) %>%
#   group_map(~get_fd_safe(.x, study = .y$study_id, plot = .y$plot))
# 
# #4610981
# #7611121

```

Format tables
```{r}
fd_table <- fd %>% 
  select(year, study_id, plot, richness = nbsp, everything(), -sing.sp) %>%
  gather(metric, value, contains("F"), RaoQ) %>%
  View()
```

