---
title: "Sensitivity Analysis"
output: html_document
date: "2022-08-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lme4)
library(broom.mixed)
library(lmerTest)
library(emmeans)

load(here::here("data/model_data.rda"))
```

Let's test the sensitivity of the general trends (and study level patterns?) to major data processing decisions.

Model fitting function
```{r}
get_model <- function(metric_name, formula, model_id, data, ...){
  print(c(metric_name, model_id))
  qlmer <- quietly(lmer)
  
  fit_data <- data %>%
    filter(metric == metric_name) %>%
    mutate(year_scaled = scale(year),
           duration_scaled = scale(duration, scale = FALSE),
           startyear_scaled = scale(startyear, scale = FALSE),
           taxa = as.factor(taxa),
           realm = as.factor(realm),
           climate = as.factor(climate))
  
  if(n_distinct(fit_data$rarefyID) < 2){
    return(tibble())
  }
  
  if(!model_id %in% c("base", "base_dur", "base_srt")){
    if(fit_data %>% pull(model_id) %>% n_distinct() >1) {
      
      fit <- qlmer(formula = formula, data = fit_data, ...)
      
      slopes <- get_fixed_slopes(metric = metric_name, model = fit$result, model_id = model_id, model_data = fit_data) 
      
      group_slopes <- as_tibble(slopes$emtrends) %>%
        mutate(effect = "group_slope", group = model_id) %>%
        rename(std.error = SE, estimate = year_scaled.trend, term = model_id)
      
      slope_constrasts <- as_tibble(slopes$contrasts) %>%
        mutate(effect = "contrast", group = model_id) %>%
        rename(std.error = SE, term = contrast, statistic = t.ratio)
      
      df <- tidy(fit$result) %>% 
        bind_rows(group_slopes, slope_constrasts) %>%
        mutate(metric = metric_name, model = list(fit$result), model_id = model_id,
               n_ts = n_distinct(fit_data$rarefyID),
               formula = formula,
               warning = ifelse(length(fit$warnings) == 0, NA, fit$warnings))
    }else{
      return(tibble())
    }
  }else{
    
    fit <- qlmer(formula = formula, data = fit_data, ...)
    
    tidy(fit$result) %>%
      mutate(metric = metric_name, model = list(fit$result), model_id = model_id, 
             n_ts = n_distinct(fit_data$rarefyID),
             formula = formula,
             warning = ifelse(length(fit$warnings) == 0, NA, fit$warnings))
  }
}

get_fixed_slopes <- function(metric, model, model_id, model_data){
  formula <- paste("pairwise", "~", model_id)
  fit_trends <- emtrends(model, specs = as.formula(formula), var="year_scaled",  mode = "satterth", lmerTest.limit = 20105, data = model_data)
  
  return(fit_trends)
}
```


1. Min time series duration
```{r}
dur_dfs <- list(min3 = filter(model_data, duration > 2),
                min4 = filter(model_data, duration > 3),
                min5 = filter(model_data, duration > 4))

duration_sens <- map_dfr(dur_dfs, ~pmap_dfr(mods, get_model, data = .x), .id = "dataID")
```

2. Inclusion of Amphibians - nothing changes when you exclude them 
```{r}
no_amph <- pmap_dfr(mods, get_model, data = model_data %>% filter(taxa != "Amphibians")) %>%
  mutate(dataID = no_amph)

# this annoyingly doesn't work because of some dataframe column
# sens_models <- bind_rows(bind_cols(select(duration_sens, -dataID), pull(duration_sens, dataID)) %>% select(-model, -formula), 
#                          no_amph %>% select(-model, -formula))

save(duration_sens, no_amph, file = here::here("data/sensitivity_models.rda"))
```


3. Trait Coverage
```{r}

```

