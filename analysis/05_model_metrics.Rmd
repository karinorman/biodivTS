---
title: "Models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
#library(moderndive)
library(lme4)
library(broom.mixed)
library(lmerTest)
```

Get data and put it in long form 
```{r}
pins::board_register_github(repo = "karinorman/biodivTS_data", branch = "master")

#get metadata
meta <- pins::pin_get("meta", board = "github") %>%
  select(study_id, realm, climate, habitat, protected_area, biome_map)

meta <- pins::pin_get("bt-traitfiltered", board = "github") %>%
  select(study_id, rarefyid, taxa) %>% distinct() %>%
  left_join(meta)

#get metric data
metrics <- pins::pin_get("rarefied-metrics", board = "github") %>%
  # pivot_longer(., cols = setdiff(everything(), one_of("rarefyID", "STUDY_ID", "SamplePool", "SampleN", "num_years", "duration", "startYear", "endYear", "YEAR", "cell", "rarefied", "type", "realm", "climate", "habitat", "biome_map", "taxa", "organisms", "cent_lat", "cent_long", "abundance_type", "BROAD_TYPE", "taxa_mod", "climate_mod")), names_to = "metric", values_to = "value") %>%
  rename_with(tolower, .cols = setdiff(everything(), one_of("rarefyID")))  %>%
  filter(!is.na(value)) %>%
  mutate(logvalue = log(value + 1)) %>% # create a column for log transformation that adds the absolute value integer closest to the most negative value to create all positive values
  left_join(meta, c("rarefyID" = "rarefyid"))
```

####Data exploration

How many years are missing FD metrics? Only a handful! Let's exclude them so we can get an accurate view of the number of years for which we have data for each timeseries                                                                                                     
```{r}
# no_fd_years <- metrics %>%
#   filter(metric %in% c("FRic", "FEve", "FDiv", "FDis"), is.na(value))
# 
# dim(no_fd_years)
# 
# metrics <- setdiff(metrics, no_fd_years)
```

Visualize number of years for each timeseries
```{r}
hist_numYears <- metrics %>%
  select(year, rarefyID) %>% 
  distinct() %>% 
  count(rarefyID, name = "num_years") %>% 
  ggplot() +
  geom_histogram(aes(x = num_years),
                 binwidth = 2) +
  scale_x_continuous(name = 'Number of years sampled',
                     breaks = c(2,4,8,16,32,48,64,96)) +
  #scale_y_continuous(breaks = c(0,2500,5000,7500,10000,12500, 15000, 17500, 20000,22500)) +
  labs(tag = 'B',
       y = 'Number of cells') +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank())
```

Visualize distributions of response
```{r}
metrics %>%
  filter(metric %in% c("FRic", "FEve", "FDiv", "FDis", "S", "Jaccard_hind")) %>%
  ggplot() +
  geom_histogram(aes(x = logvalue),
                 bins = 60) +
  facet_wrap(~metric, scales = "free") +
  labs(title = "Distribution of Log values")

metrics %>%
  filter(metric %in% c("FRic", "FEve", "FDiv", "FDis", "S", "SES_FDis", "SES_FDiv", "SES_FEve", "SES_FRic", "Jaccard_hind")) %>%
  ggplot() +
  geom_histogram(aes(x = value),
                 bins = 60) +
  facet_wrap(~metric, scales = "free") +
  labs(title = "Distribution of raw values")
```

Fit GLM to overall metric trend

Convergence problems!! See here:
https://joshua-nugent.github.io/allFit/
https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
https://biologyforfun.wordpress.com/2018/04/09/help-i-have-convergence-warnings/

Maybe need something other than a gaussian distribution?

Model checks:
https://debruine.github.io/posts/normality/
performance::check_model()

```{r}
#find rarefyID's that have inf value for some metrics and exclude
cont_inf <- metrics %>% filter(is.infinite(value), !metric %in% c("qual.FRic",  "SES_qual.FRic")) %>% pull(rarefyID) 

#get rarefyID's that don't have enough null samples
missing_null <- bind_rows(metrics %>% 
  filter(n_missing_nulls == 1, commplete_null_samps == FALSE),
  metrics %>% filter(n_missing_nulls > 100)) %>%
  pull(rarefyID) %>%
  unique()

model_data <- metrics %>% 
  filter(!rarefyID %in% cont_inf, !rarefyID %in% missing_null) %>%
  group_by(metric) %>%
  mutate(study_id =  str_extract(rarefyID, "[^_]+")) %>%
  mutate(year_scaled = scale(year), 
         scale_center = attributes(year_scaled)$`scaled:center`, 
         scale = attributes(year_scaled)$`scaled:scale`) %>%
  ungroup()

# model for overall trend (random effect w/varying intercept)
# metric_mean_fit <- model_data %>%
#   filter(metric %in%  c("FRic", "FEve", "FDiv", "FDis", "S")) %>%
#   group_nest(metric) %>%
#   mutate(model = map(data, ~lmer(log(value + 1) ~ year_scaled + (1|study_id/rarefyID), data = .x, REML = FALSE,
#                   control = lmerControl(optCtrl = list(maxit = 1e9,
#                                                     maxfun = 1e9,
#                                                     xtol_abs = 1e-11,
#                                                     ftol_abs = 1e-11,
#                                                     maxeval = 1e9)))),
#          null_model = map(data, ~lmer(logvalue ~ (1|study_id/rarefyID), data = .x, REML = FALSE,
#                   control = lmerControl(optCtrl = list(maxit = 1e9,
#                                                     maxfun = 1e9,
#                                                     xtol_abs = 1e-11,
#                                                     ftol_abs = 1e-11,
#                                                     maxeval = 1e9)))),
#            
#            test = map2(model, null_model, anova),
#            test_res = map(test, tidy),
#            coef = map(model, tidy)
#            ) %>% 
#   unnest(cols = c(test_res)) %>%
#   select(metric, model, coef, p.value) %>%
#   filter(!is.na(p.value)) %>%
#   unnest(cols = c(coef)) %>%
#   filter(term == "year_scaled") %>%
#   select(-c(effect, group, term, statistic))

SES_rand_slope <- model_data %>%
  #filter(protected_area == "FALSE") %>%
  #filter(metric %in%  c("SES_FRic", "SES_FEve", "SES_FDiv", "SES_FDis", )) %>%
  filter(metric %in%  c("SES_FRic", "SES_FEve", "SES_FDiv", "Jaccard_base", "Jaccard_next")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(value ~ year_scaled + (year_scaled|study_id/rarefyID), 
                                 data = .x)),
           # null_model = map(data, ~lmer(value ~ (year_scaled|study_id/rarefyID), 
           #                       data = .x)),
           # test = map2(model, null_model, anova),
           # test_res = map(test, tidy),
           coef = map(model, tidy)
           ) %>% 
  select(metric, model, coef) %>%
  unnest(cols = c(coef)) %>%
  filter(term == "year_scaled") %>%
  select(-c(effect, group, term, statistic))

metric_rand_slope <- model_data %>%
  #filter(metric %in%  c("FRic", "FEve", "FDiv", "FDis", "S")) %>%
  filter(metric %in%  c("FRic", "FEve", "FDiv", "S")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(logvalue ~ year_scaled + (year_scaled|study_id/rarefyID), 
                                 data = .x, REML = FALSE)),
           coef = map(model, tidy)
           ) %>% 
  select(metric, model, coef) %>%
  unnest(cols = c(coef)) %>%
  filter(term == "year_scaled") %>%
  select(-c(effect, group, term, statistic))

# model_comp <- metric_mean_fit %>%
#   select(metric, no_slope_estimate = estimate, no_slope_pval = p.value) %>%
#   left_join(metric_mean_fit_slope %>% 
#   select(metric, slope_estimate = estimate, slope_pval = p.value ))

metric_model_table <- bind_rows(select(SES_rand_slope, -model), select(metric_rand_slope, -model))
```

Kitchen sink model
```{r}
all_model <- model_data %>%
  filter(metric %in%   c("SES_FRic", "SES_FEve", "SES_FDiv", "SES_FDis")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(value ~ year_scaled + taxa + realm + (year_scaled|study_id/rarefyID), 
                                 data = .x)),
           null_model = map(data, ~lmer(value ~ taxa + realm + (year_scaled|study_id/rarefyID),
                                 data = .x)),
           test = map2(model, null_model, anova),
           test_res = map(test, tidy),
           coef = map(model, tidy)
           ) %>%
  unnest(cols = c(test_res)) %>%
  select(metric, model, coef, p.value) %>%
  filter(!is.na(p.value)) %>%
  unnest(cols = c(coef)) %>%
  filter(term == "year_scaled") %>%
  select(-c(effect, group, term, statistic))
```
Models with categorical study characteristics as random effects 

Taxa:
```{r}
taxa_slope_model <- model_data %>%
  filter(metric %in%   c("SES_FRic", "SES_FEve", "SES_FDiv")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(value ~ year_scaled + taxa + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = .x, REML = TRUE)),
           coef = map(model, tidy)) %>%
  select(metric, coef) %>%
  unnest(cols = c(coef)) %>%
  #filter(term == "year_scaled") %>%
  filter(term %in% c("year_scaled", "taxaBirds", "taxaMammals")) %>%
  select(-c(effect, group, statistic))

taxa_slope_model_S <- model_data %>% 
  filter(metric == "S") %>%
  lmer(logvalue ~ year_scaled + taxa + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = ., REML = TRUE)
```
Realm:
```{r}
realm_slope_model <- model_data %>%
  filter(metric %in%   c("SES_FRic", "SES_FEve", "SES_FDiv")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(value ~ year_scaled + realm + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = .x, REML = TRUE)),
           coef = map(model, tidy)) %>%
  select(metric, coef) %>%
  unnest(cols = c(coef)) %>%
  #filter(term == "year_scaled") %>%
  filter(effect == "fixed") %>%
  select(-c(effect, group, statistic))

realm_slope_model_S <- model_data %>% 
  filter(metric == "S") %>%
  lmer(logvalue ~ year_scaled + realm + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = ., REML = TRUE)
```
Climate:
```{r}
climate_slope_model <- model_data %>%
  filter(metric %in%   c("SES_FRic", "SES_FEve", "SES_FDiv")) %>%
  group_nest(metric) %>%
  mutate(model = map(data, ~lmer(value ~ year_scaled + climate + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = .x, REML = TRUE)),
           coef = map(model, tidy)) %>%
  select(metric, coef) %>%
  unnest(cols = c(coef)) %>%
  #filter(term == "year_scaled") %>%
  filter(effect == "fixed") %>%
  select(-c(effect, group, statistic))

climate_slope_model_S <- model_data %>% 
  filter(metric == "S") %>%
  lmer(logvalue ~ year_scaled + climate + (year_scaled|study_id/rarefyID), # + (year_scaled|taxa), 
                                 data = ., REML = TRUE)
```

Get study level slop estimates
```{r}
get_blup <- function(metric, model){
  coef(model)$study_id %>%
    rownames_to_column("study_id") %>%
    mutate(metric = metric)
}

blup <- pmap_dfr(bind_rows(select(SES_rand_slope, metric, model), select(metric_rand_slope,  metric, model)), get_blup) %>%
  rename(intercept = "(Intercept)")

blup_slope <- blup %>%
  pivot_wider(names_from = "metric", values_from = "year_scaled")

#pairwise plots using GGally
ggpairs(blup_slope %>% 
          select(-c("study_id", "FDiv", "FEve", "FRic")))

#pairwise plots using GGPlot
gatherpairs <- function(data, ..., 
                        xkey = '.xkey', xvalue = '.xvalue',
                        ykey = '.ykey', yvalue = '.yvalue',
                        na.rm = FALSE, convert = FALSE, factor_key = FALSE) {
  vars <- quos(...)
  xkey <- enquo(xkey)
  xvalue <- enquo(xvalue)
  ykey <- enquo(ykey)
  yvalue <- enquo(yvalue)

  data %>% {
    cbind(gather(., key = !!xkey, value = !!xvalue, !!!vars,
                 na.rm = na.rm, convert = convert, factor_key = factor_key),
          select(., !!!vars)) 
  } %>% gather(., key = !!ykey, value = !!yvalue, !!!vars,
               na.rm = na.rm, convert = convert, factor_key = factor_key)
}

blup_slope %>% 
  gatherpairs( "SES_FDiv", "SES_FEve", "SES_FRic", "S") %>% {
  ggplot(., aes(x = .xvalue, y = .yvalue)) +
      geom_point() + 
      #geom_smooth(method = 'lm') +
      facet_wrap(.xkey ~ .ykey, ncol = length(unique(.$.ykey)), scales = 'free', labeller = label_both) +
      scale_color_brewer(type = 'qual')
  }

blup_slope %>%
  select(-c("FDiv", "FEve", "FRic")) %>%
  pivot_longer(-one_of("study_id", "S"), names_to = "metric") %>%
  ggplot(aes(x = S, y = value)) +
  geom_point() +
  facet_wrap(~metric) +
  xlim(-1.3, 1.3) +
  ylim(-0.6, 0.6) +
    theme_classic() +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) + 
  ylab("Metric Slope") +
  xlab("Richness Slope")

blup_slope %>%
  select(-c("FDiv", "FEve", "FRic")) %>%
  pivot_longer(-one_of("study_id", "SES_FRic"), names_to = "metric") %>%
  ggplot(aes(x = SES_FRic, y = value)) +
  geom_point() +
  facet_wrap(~metric) +
  xlim(-.25, .25) +
  ylim(-0.6, 0.6) +
    theme_classic() +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) + 
  ylab("Metric Slope") +
  xlab("Functional Richness Slope")
```

Clustering 
```{r}
library(clValid)
scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

blup_mat <- blup_slope %>%  
  #these studies have NA's for some reason, remove them 
  filter(!study_id %in% c(445, 446, 348, 382, 312)) %>%
  select(study_id, starts_with("SES"), S) %>%
  column_to_rownames("study_id") %>%
  mutate(across(.fns = scale2)) %>%
  as.matrix()

clmethods <- c("hierarchical","kmeans","pam")
intern <- clValid(blup_mat, nClust = 2:6, clMethods = clmethods, validation = "internal")
stab <- clValid(blup_mat, nClust = 2:6, clMethods = clmethods, validation = "stability")

summary(intern)
optimalScores(stab)

#get the hierarchical clustering object
clust <- intern@clusterObjs$hierarchical
cat5 <- cutree(clust, k = 5)
cat3 <- cutree(clust, k = 3)


blup_clust <- blup_slope %>% 
  left_join(as.data.frame(cat3) %>%
  rownames_to_column("study_id")) %>%
  left_join(as.data.frame(cat5) %>%
  rownames_to_column("study_id"))
```
```{r}
blup_clust %>% 
  gatherpairs( "SES_FDiv", "SES_FEve", "SES_FRic", "S") %>% {
  ggplot(., aes(x = .xvalue, y = .yvalue, color = as.factor(cat5))) +
      geom_point() + 
      #geom_smooth(method = 'lm') +
      facet_wrap(.xkey ~ .ykey, ncol = length(unique(.$.ykey)), scales = 'free', labeller = label_both) +
      scale_color_brewer(type = 'qual')
  }
```

##Figures
Reproduce Dornelas figure - all data points & regressions w/overall mean
```{r}
#get climate classification
metadata <- read_csv(system.file("extdata", "biotime/biotime_metadata.csv", package = "biodivTS"))

fric_trend <- metrics %>%
  filter(metric == "FRic") %>%
  ggplot(aes(x = year, y = logvalue)) +
  # geom_smooth(aes(color = climate, group = plot_id), method = "glm", se = FALSE) +
  # geom_point(aes(color = climate, group = plot_id)) +
  geom_smooth(aes(group = rarefyID), color = "grey", method = "glm", se = FALSE) +
  geom_point(aes(group = rarefyID) ,color = "grey") +
  geom_smooth(color = "black", method = "glm", se = FALSE) +
  theme(legend.position = "none") 
ggsave("fric_trends.png", fric_plot)
```

```{r}
library(lme4)

plot_metric <- function(metric_name, ylabel, yval, data, model_coef){

  data <- data %>%
    filter(metric == metric_name, !is.na(value), !is.infinite(value))

  model_coef <- model_coef %>%
    filter(metric == metric_name) %>%
    select(term, estimate)
  
  intercept <- model_coef %>% filter(term == "(Intercept)") %>% pull(estimate)
  slope <- model_coef %>% filter(term == "year_scaled") %>% pull(estimate)
  
  pred <- data %>%
    select(year_scaled) %>%
    distinct() %>%
    mutate(pred = intercept + year_scaled * slope)

  trend_plot <- data %>%
    left_join(pred, by = "year_scaled") %>%
    #left_join(metadata %>% select(study_id, climate)) %>%
    ggplot(aes(x = year, y = !!sym(yval))) +
    # geom_smooth(aes(color = climate, group = rarefyID), method = "glm", se = FALSE) +
    # geom_point(aes(color = climate, group = rarefyID)) +
    geom_point(aes(group = rarefyID) ,color = "grey", size = 0.50) +
    geom_smooth(aes(color = climate, group = study_id), method = "glm", se = FALSE, size = 0.7) +
    #geom_smooth(color = "black", method = "glm", se = FALSE) +
    geom_line(mapping = aes(y = pred)) +
    theme(legend.position = "none") +
    theme_classic() +
    ylab(ylabel) +
    labs(color = "Climate") +
    scale_fill_jcolors(palette = "pal7")
  
  ggsave(paste0(here::here("figures"), "/",metric_name, "_trend.png"), trend_plot)
  return(trend_plot)
}

model_coef <- bind_rows(SES_rand_slope, metric_rand_slope) %>%
  select(metric, model) %>%
   mutate(coef = map(model, tidy)) %>% 
  select(-model) %>% 
  unnest(cols = c(coef))

plot_metric("FRic", "log(FD)")

plot_map <- tibble(metric_name = c("S", "SES_FRic", "Jaccard_base"), 
           ylabel = c("log(S)", "Functional Richness", "Jaccard"),
           yval = c("logvalue", "value", "value"))
m_plots <- pmap(plot_map, plot_metric, data = model_data, model_coef = model_coef)

plot_join <- plot_grid(plotlist=m_plots, labels = c("A", "B", "C"), nrow = 1)
```
