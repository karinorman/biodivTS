---
title: "AmphibBio"
author: "Kari Norman"
date: "5/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

source(here::here("data-raw", "helper_functions.R"))
```

Get id's for amphibio database from itis
```{r}
#original data from https://figshare.com/articles/Oliveira_et_al_AmphiBIO_v1/4644424

amph <- read_csv(system.file("extdata", "amphibio/AmphiBIO_v1.csv", package = "biodivTS"))

amphibio <- amph %>%
  mutate(id = get_ids(Species, "itis")) %>%
  filter(!is.na(id)) %>%
  mutate(scientificName = get_names(id, "itis")) %>%
  select(id, scientificName, Species) %>%
  right_join(select(amph, -id), by = "Species") %>%
  rename(sourceName = Species) %>%
  select(-c("Order", "Family", "Genus")) 

# Using by_ doesn't give any additional ids
# amphibio <- by_name(amph$Species, "itis") %>%
#   filter(taxonRank == "species") %>% #only want ID's to species, since that's the level of the trait data
#   drop_na(acceptedNameUsageID)
```

Check for matches from other providers
```{r}
syn_res <- match_providers(amphibio, "itis")

#names that resolve to more than one id
alt_dupes <- syn_res %>%
  select(acceptedNameUsageID, input) %>%
  distinct() %>%
  group_by(input) %>%
  filter(n() > 1)

add_syn_res <- syn_res %>% 
  filter(!input %in% alt_dupes$input) %>% #excluding duplicate matched species
  select(id = acceptedNameUsageID, sourceName = input, scientificName) %>%
  distinct() %>%
  group_by(sourceName) %>%
  top_n(1, scientificName) %>%
  left_join(amphibio %>% select(-c(id, scientificName)), by = "sourceName", na_matches =  "never") %>%
  ungroup() %>%
  distinct()

amphibio <- amphibio %>% 
  filter(!sourceName %in% add_syn_res$sourceName) %>%
  bind_rows(add_syn_res)
```

Check for multiple matches to the same ID
```{r}
#get ids that have more than one entry
dupe_ids <- amphibio %>% 
  select(id, sourceName) %>% 
  drop_na(id) %>%
  distinct() %>% 
  group_by(id) %>% 
  filter(n() > 1) %>%
  pull(id)

#get data associated with ids
dupe_data <- amphibio %>% 
  filter(id %in% dupe_ids)

#resolve so that traits are averaged for species that need to be combined
resolved <- dupe_data %>%
  select(-scientificName, -sourceName) %>%
  group_by(id) %>%
  summarise_all(~ if (all(is.na(.))) {NA} else {mean(., na.rm = TRUE)}) %>%
  mutate(scientificName = get_names(id))

#remove unresolved data and replace with new resolved
amphibio <-  amphibio %>% 
  anti_join(dupe_data) %>% 
  bind_rows(resolved)

```

```{r}
usethis::use_data(amphibio)
```

