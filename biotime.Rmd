---
title: "BioTime"
author: "Kari Norman"
date: "4/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(lazyeval)
library(rdataretriever)

```

Import occurence data from Biotime
```{r}
#rdataretriever::install("biotime", connection = "csv", data_dir = here("data"))

data <- read_csv(here("data", "biotime_metadata.csv")) %>% filter(taxa %in% c("Birds", "Mammals")) %>%
  select(study_id, taxa) %>%
  left_join(read_csv(here("data", "biotime_query.csv")), by = "study_id")
  
```

Get mammal and trait data
```{r}
bird_trait <- read_csv(here("data/elton_traits/elton_traits_BirdFuncDat.csv"))
mamm_trait <- read.csv(here("data/elton_traits/elton_traits_MammFuncDat.csv"))
```

Check which authority would result in the most matches 
```{r}
library(taxadb)

get_match_counts <- function(data, species_col){
  species_col <- lazyeval::as_name(species_col)
  data %>% 
    select(!!species_col) %>% 
    drop_na() %>%
    distinct() %>%
    mutate(
      gbif = get_ids(!!species_col, "gbif"),
      col = get_ids(!!species_col, "col" ),
      itis = get_ids(!!species_col, "itis"),
      ncbi = get_ids(!!species_col, "ncbi"),
      wd = get_ids(!!species_col, "wd"  ),
      iucn = get_ids(!!species_col, "iucn"),
      ott = get_ids(!!species_col, "ott" ) 
    ) %>%
    #select(!!call("-", species_col)) %>%
    purrr::map_dbl(function(x) sum(!is.na(x)))
}

##Counts show that OTT is the best authority for both data sets
get_match_counts(data %>% filter(taxa == "Birds"), "genus_species")
get_match_counts(data, "genus_species")
get_match_counts(bird_trait, "scientific")
get_match_counts(mamm_trait, "scientific")
```

OTT is the best authority but doesn't have common names, so we use the next best ITIS. We'll start with BioTime data:

##Biotime

```{r}
#Getting matches by scientific name 
biotime <- data %>% 
  #filter(taxa == "Birds") %>%
  select(genus_species) %>%
  drop_na() %>%
  distinct() %>%
  mutate(id = get_ids(genus_species, "itis")) %>%
  left_join(data, by = "genus_species")

#Getting matches by sci name and common name 
biotime_ids <- by_name(unique(data$genus_species), "itis") %>%
  bind_rows(by_common(unique(data$genus_species), "itis")) %>%
  filter(taxonRank == "species") %>% #only want ID's to species, since that's the level of the trait data
  drop_na(acceptedNameUsageID)
```

Some names match to multiple acceptedUsage ID's, so we have to manually choose which one we want. In this case it's just the Blue-winged warbler
```{r}

get_dupe_ids <- function(data, orig_id){
  orig_id <- lazyeval::as_name(orig_id)
  
  data %>%
    distinct(acceptedNameUsageID, input, !!orig_id) %>%
    group_by(!!orig_id) %>% 
    filter(n()>1) %>% 
    ungroup()
}  

unres <- get_dupe_ids(biotime_ids, "sort")
unres 
```

Add the unresolved ID to all the other ids and join with biotime data
```{r}
biotime_ids <- unres %>%
left_join(biotime_ids) %>% #join ID's back with all the columns
  filter(taxonomicStatus == "accepted") %>% #want the accepted ID from the two Warbler options
  bind_rows(biotime_ids %>% filter(!sort %in% unres$sort)) #join to resolved ID's, excluding the observations we resolved manually

biotime_data <- biotime_ids %>%
  select(id = acceptedNameUsageID,input, scientificName) %>%
  distinct() %>%
  right_join(data %>% select(-species, -genus), by = c("input" = "genus_species")) %>%
  rename(matchingName = input)
```



##Elton Traits
Get id's for the Elton Bird trait data
```{r}
sci_names <-  by_name(unique(bird_trait$scientific), "itis") %>%
  drop_na(acceptedNameUsageID) %>%
  #get original specid so we can figure out how many don't have matches
  left_join(bird_trait %>% select(specid, scientific), by = c("input" = "scientific")) %>%
  mutate(match_type = "scientific")
  
com_names <- bird_trait %>% 
  filter(!specid %in% sci_names$specid) %>%
  pull(english) %>%
  unique() %>%
  by_common("itis") %>%
  #mutate(match_type = "common")
  #filter(taxonRank == "species") %>% #only want ID's to species, since that's the level of the trait data
  drop_na(acceptedNameUsageID) %>%
  left_join(bird_trait %>% select(specid, english), by = c("input" = "english"))%>%
  mutate(match_type = "common")


#there are both sci and common names, only want common name 
bird_ids <- bind_rows(sci_names, com_names)
```

Are there any unresolved ids? Yes - just one, which is a synonym to two different accepted id's
```{r}
unres_trait <- get_dupe_ids(bird_ids, "specid") %>%
  left_join(bird_ids)

unres_trait

#resolve to the desired ID (in this case the one with complete hierarchy data)
bird_ids <- unres_trait %>% 
  filter(!is.na(kingdom)) %>%
  bind_rows(bird_ids %>% filter(!sort %in% unres_trait$sort))
  
#only want one column for old name and one column for new name, these are the old ID columns to remove
col_ex <- c("passnonpass", "iocorder", "blfamilylatin", "blfamilyenglish", "blfamsequid", "taxo")

#join on scientific and common
sci_matches <- bird_ids  %>%
  filter(match_type == "scientific") %>%
  select(id = acceptedNameUsageID, input, scientificName) %>%
  distinct() %>%
  right_join(bird_trait %>% select(.dots = -col_ex), by = c("input" = "scientific"), na_matches = "never") %>%
  drop_na(id) %>%
  distinct() %>%
  select(-english)

comm_matches <- bird_ids  %>%
  filter(match_type == "common") %>%
  select(id = acceptedNameUsageID, input, scientificName) %>%
  distinct() %>%
  right_join(bird_trait %>% filter(!specid %in% sci_matches$specid) %>% select(.dots = -col_ex), by = c("input" = "english"), na_matches = "never") %>%
  distinct() %>%
  rename(matchingName = input) %>%
  select(-scientific)

#there are more rows after ID data is joined because for species that matched on common names there may be more than one scientificName 
bird_trait_data <- bind_rows(sci_matches, comm_matches)
```

check if all bird biotime data w/id's has an elton match. There are 38 species without a match
```{r}
biotime_data %>%
  filter(taxa == "Birds") %>%
  select(id) %>%
  distinct() %>%
  filter(!id %in% bird_trait_data$id) %>%
  dim()
```

and 605 species without an ID
```{r}
biotime_data %>%
  filter(taxa == "Birds") %>%
  select(id, matchingName) %>%
  distinct() %>%
  filter(is.na(id)) %>%
  dim()
```

Are there any studies for which we have trait data for all species?
```{r}
#join trait and biotime data
bird_data <- biotime_data %>%
  #filter(taxa == "Birds") %>%
  rowid_to_column("row") %>%
  left_join(bird_trait_data %>% 
              select(), 
            na_matches = "never")

coverage <- bird_data %>%
  group_by(study_id) %>%
  summarise(perc = sum(!is.na(id))/n()) %>%
  arrange(desc(perc))

head(coverage)
```

